const cds = require('@sap/cds/lib')
const { set_ } = require('./add')

const readExtension = async function (req) {
  const tenant = _tenant(req)
  if (tenant) cds.context = { tenant } // req.data.tenant from header if exists

  const ext = !req.data?.ID ? await SELECT.from('cds.xt.Extensions') : await SELECT.one.from('cds.xt.Extensions').where({ tag: req.data.ID })
  if (Array.isArray(ext)) return ext.map(item => ({ ID: item.tag, csn: item.csn, timestamp: item.timestamp }))
  if (ext) return { ID: ext.tag, csn: ext.csn, timestamp: ext.timestamp }
  return ext
}

const updateExtension = async function (req) {
  const tenant = _tenant(req)
  // set handles the tenant switch in that case
  await set_(req, { extension: [...req.data.csn], tag: req.data.ID, tenant: tenant ?? req.tenant })
  const res = await SELECT.one.from('cds.xt.Extensions').where({ tag: req.data.ID })
  return { ID: res.tag, csn: res.csn, timestamp: res.timestamp }
}

const deleteExtension = async function (req) {
  const tenant = _tenant(req)
  if (tenant) cds.context = { tenant } // req.data.tenant from header if exists

  return !req.data?.ID ? DELETE.from('cds.xt.Extensions') : DELETE.from('cds.xt.Extensions').where({ tag: req.data.ID })
}

function _tenant(req) {
  const tenant = req.headers['x-tenant-id']
  if (!req.user.is('internal-user') && tenant && tenant !== req.tenant)
    req.reject(403, `No permission to promote extensions by tenants other than ${req.tenant}`)
  return tenant
}

module.exports = { readExtension, updateExtension, deleteExtension }
